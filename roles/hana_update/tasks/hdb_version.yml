---

# SPDX-License-Identifier: GPL-3.0-only
# SPDX-FileCopyrightText: 2023 Red Hat, Project Atmosphere
#
# Copyright 2023 Red Hat, Project Atmosphere
#
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU
# General Public License as published by the Free Software Foundation, version 3 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# You should have received a copy of the GNU General Public License along with this program.
# If not, see <https://www.gnu.org/licenses/>.

# 2321087 - How to find the Revision of the SAP HANA Database
- name: Get SAP HANA version (resident)
  ansible.builtin.shell:
    cmd: source ~/.profile && HDB version
  become: true
  become_user: "{{ hana_update_sid | lower }}adm"
  changed_when: false
  register: hana_update_hdb_version_resident

- name: Get version data (resident)
  vars:
    version: "{{ item | regex_replace('^(.+?)version:(.+?)$', '\\2') | trim }}"
  ansible.builtin.set_fact:
    hana_update_hdb_version_resident_str: "{{ version }}"
  with_items: "{{ hana_update_hdb_version_resident.stdout_lines }}"
  when: item | regex_search('version:')

- name: Get SAP HANA version (medium)
  ansible.builtin.command:
    cmd: "{{ hana_update_component_medium }}/DATA_UNITS/HDB_SERVER_LINUX_X86_64/hdblcm
      --action=print_detected_components
      --component_medium={{ hana_update_component_medium }}"
  become: true
  become_user: root
  changed_when: false
  register: hana_update_hdb_version_medium

- name: Get version data (medium)
  vars:
    version_name: "{{ item | regex_replace('^(.+?)\\|(.+?)\\|(.+?)\\|(.+?)\\|(.+?)$', '\\2') | trim }}"
    version: "{{ item | regex_replace('^(.+?)\\|(.+?)\\|(.+?)\\|(.+?)\\|(.+?)$', '\\3') | trim }}"
    batch_key: "{{ item | regex_replace('^(.+?)\\|(.+?)\\|(.+?)\\|(.+?)\\|(.+?)$', '\\4') | trim }}"
    location: "{{ item | regex_replace('^(.+?)\\|(.+?)\\|(.+?)\\|(.+?)\\|(.+?)$', '\\5') | trim }}"
  ansible.builtin.set_fact: >
    hana_update_hdb_version_medium_list: "{{ hana_update_hdb_version_medium_list | default([]) +
      [{
      'name': version_name,
      'version': version,
      'batch_key': batch_key,
      'location': location
      }] }}"
  with_items: "{{ hana_update_hdb_version_medium.stdout_lines }}"
# TODO: use ansible version test to compare versions
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html#comparing-versions

- name: Get HDB server medium version
  ansible.builtin.set_fact:
    hana_update_hdb_version_medium_str: "{{ item.version }}"
  when: item.batch_key == 'server'
  with_items: "{{ hana_update_hdb_version_medium_list }}"
